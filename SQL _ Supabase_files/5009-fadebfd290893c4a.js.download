"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5009],{95009:function(e,r,t){t.d(r,{Z:function(){return R}});var n=t(20406),s=t(28526),o=t.n(s),i=t(55830),a=t(39097),c=t.n(a),l=t(5632),u=t(2784),d=t(25208),p=t(8647),f=t(36849),h=t(43635),g=t(23733),v=t(35981),j=t(31786),b=t(4300),m=t(32366),x=t(95235),y=t(82269),w=t(62350),O=t(62202),_=t(81229),P=["onSuccess","onError"];function k(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,n)}return t}function N(){return(N=(0,n.Z)(o().mark(function e(r){var t,n,s,i,a;return o().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.ref,n=r.target_version,e.next=3,(0,_.v_)("/v1/projects/{ref}/upgrade",{params:{path:{ref:t}},body:{target_version:n}});case 3:if(i=(s=e.sent).data,!(a=s.error)){e.next=8;break}throw a;case 8:return e.abrupt("return",i);case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}var Z=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=e.onSuccess,t=e.onError,s=(0,y.Z)(e,P);return(0,w.D)(function(e){return function(e){return N.apply(this,arguments)}(e)},function(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?k(Object(t),!0).forEach(function(r){(0,x.Z)(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):k(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})}return e}({onSuccess:function(e,t,s){return(0,n.Z)(o().mark(function n(){return o().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,null==r?void 0:r(e,t,s);case 2:case"end":return n.stop()}},n)}))()},onError:function(e,r,s){return(0,n.Z)(o().mark(function n(){return o().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:void 0===t?O.Am.error("Failed to upgrade project: ".concat(e.message)):t(e,r,s);case 1:case"end":return n.stop()}},n)}))()}},s))},C=t(29298),S=t(70203),D=t(9747),E=t(52322),R=function(){var e,r,t,s,a,x,y=(0,l.useRouter)(),w=(0,S.oR)().ui,O=(0,b.UO)().ref,_=(0,i.NL)(),P=(0,u.useState)(!1),k=P[0],N=P[1],R=(0,m.DU)({projectRef:O}).data,U=(null!==(r=null==R?void 0:R.current_app_version)&&void 0!==r?r:"").split("supabase-postgres-")[1],z=(null!==(t=null==R?void 0:R.latest_app_version)&&void 0!==t?t:"").split("supabase-postgres-")[1],T=(null==R?void 0:R.duration_estimate_hours)||1,Y=(null==R?void 0:R.legacy_auth_custom_roles)||[],A={version:null!==(s=null==R?void 0:null===(a=R.target_upgrade_versions)||void 0===a?void 0:null===(x=a[0])||void 0===x?void 0:x.postgres_version)&&void 0!==s?s:0},W=Z({onSuccess:function(e,r){(0,C.k7)(_,r.ref,D.S.UPGRADING),w.setNotification({category:"success",message:"Upgrading project"}),y.push("/project/".concat(r.ref,"?upgradeInitiated=true"))}}),F=W.mutate,I=W.isLoading,L=(e=(0,n.Z)(o().mark(function e(r){return o().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(O){e.next=2;break}return e.abrupt("return",w.setNotification({category:"error",message:"Project ref not found"}));case 2:F({ref:O,target_version:r.version});case 3:case"end":return e.stop()}},e)})),function(r){return e.apply(this,arguments)});return(0,E.jsxs)(E.Fragment,{children:[(0,E.jsxs)(d.bZ,{title:"Your project can be upgraded to the latest version of Postgres",children:[(0,E.jsx)(d.Cd,{children:"Your project can be upgraded to the latest version of Postgres"}),(0,E.jsxs)(d.X,{children:[(0,E.jsxs)("p",{className:"mb-3",children:["The latest version of Postgres (",z,") is available for your project."]}),(0,E.jsx)(p.z,{size:"tiny",type:"primary",onClick:function(){return N(!0)},children:"Upgrade project"})]})]}),(0,E.jsx)(f.C,{hideFooter:!0,visible:k,onCancel:function(){return N(!1)},header:(0,E.jsx)("h3",{children:"Upgrade Postgres"}),children:(0,E.jsx)(h.Z,{id:"project-upgrade-form",initialValues:A,onSubmit:L,children:function(e){var r,t,n,s,o=e.values,i=(null!==(r=null==R?void 0:R.target_upgrade_versions)&&void 0!==r?r:[]).find(function(e){return e.postgres_version===o.version});return(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)("div",{className:"py-6",children:(0,E.jsx)(f.C.Content,{children:(0,E.jsxs)("div",{className:"space-y-4",children:[(0,E.jsx)("p",{className:"text-sm",children:"All services are going offline."}),(0,E.jsxs)("p",{className:"text-sm",children:["You will not be able to downgrade back to Postgres ",U,"."]}),(0,E.jsxs)(d.bZ,{title:"Your project will be offline while the upgrade is in progress",children:[(0,E.jsx)(g.Z,{className:"h-4 w-4",strokeWidth:2}),(0,E.jsxs)(d.Cd,{children:["Your project will be offline for up to ",T," hour",1===T?"":"s"]}),(0,E.jsx)(d.X,{children:(0,E.jsx)("p",{children:"It is advised to upgrade at a time when there will be minimal impact for your application."})})]}),(null!==(t=null==R?void 0:R.potential_breaking_changes)&&void 0!==t?t:[]).length>0&&(0,E.jsxs)(d.bZ,{variant:"destructive",title:"Breaking changes",children:[(0,E.jsx)(g.Z,{className:"h-4 w-4",strokeWidth:2}),(0,E.jsx)(d.Cd,{children:"Breaking changes"}),(0,E.jsxs)(d.X,{className:"flex flex-col gap-3",children:[(0,E.jsx)("p",{children:"Your project will be upgraded across major versions of Postgres. This may involve breaking changes."}),(0,E.jsx)("div",{children:(0,E.jsx)(p.z,{size:"tiny",type:"default",asChild:!0,children:(0,E.jsx)(c(),{href:"https://supabase.com/docs/guides/platform/migrating-and-upgrading-projects#caveats",target:"_blank",rel:"noreferrer",children:"View docs"})})})]})]}),Y.length>0&&(0,E.jsxs)(d.bZ,{variant:"warning",title:"Custom Postgres roles using md5 authentication have been detected",children:[(0,E.jsx)(v.Z,{className:"h-4 w-4",strokeWidth:2}),(0,E.jsx)(d.Cd,{children:"Custom Postgres roles will not work automatically after upgrade"}),(0,E.jsxs)(d.X,{className:"flex flex-col gap-3",children:[(0,E.jsx)("p",{children:"You must run a series of commands after upgrading."}),(0,E.jsx)("p",{children:"This is because new Postgres versions use scram-sha-256 authentication by default and do not support md5, as it has been deprecated."}),(0,E.jsxs)("div",{children:[(0,E.jsx)("p",{className:"mb-1",children:"Run the following commands after the upgrade:"}),(0,E.jsx)("div",{className:"flex items-baseline gap-2",children:(0,E.jsx)("code",{className:"text-xs",children:Y.map(function(e){return(0,E.jsxs)("div",{className:"pb-1",children:["ALTER ROLE ",(0,E.jsx)("span",{className:"text-brand",children:e})," WITH PASSWORD '",(0,E.jsx)("span",{className:"text-brand",children:"newpassword"}),"';"]},e)})})})]}),(0,E.jsx)("div",{children:(0,E.jsx)(p.z,{size:"tiny",type:"default",asChild:!0,children:(0,E.jsx)(c(),{href:"https://supabase.com/docs/guides/platform/migrating-and-upgrading-projects#caveats",target:"_blank",rel:"noreferrer",children:"View docs"})})})]})]}),(0,E.jsx)(j.Z,{id:"version",name:"version",label:"Select the version of Postgres to upgrade to",descriptionText:"Postgres will be upgraded from ".concat(U," to ").concat(null!==(n=null==i?void 0:null===(s=i.app_version)||void 0===s?void 0:s.split("supabase-postgres-")[1])&&void 0!==n?n:o.version),children:null==R?void 0:R.target_upgrade_versions.map(function(e){return(0,E.jsxs)(j.Z.Option,{value:e.postgres_version,label:"".concat(e.postgres_version," (").concat(e.app_version.split("supabase-postgres-")[1],")"),children:[e.postgres_version," (",e.app_version.split("supabase-postgres-")[1],")"]},e.postgres_version)})})]})})}),(0,E.jsxs)("div",{className:"flex items-center space-x-2 justify-end px-4 py-4 border-t",children:[(0,E.jsx)(p.z,{type:"default",onClick:function(){return N(!1)},disabled:I,children:"Cancel"}),(0,E.jsx)(p.z,{htmlType:"submit",disabled:I,loading:I,children:"Confirm upgrade"})]})]})}})})]})}},32366:function(e,r,t){t.d(r,{DU:function(){return g}});var n=t(95235),s=t(82269),o=t(20406),i=t(28526),a=t.n(i);t(2784);var c=t(58943),l=t(37552),u=t(9747),d=t(23560),p=["enabled"];function f(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,n)}return t}function h(){return(h=(0,o.Z)(a().mark(function e(r,t){var n,s;return a().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.projectRef){e.next=3;break}throw Error("projectRef is required");case 3:return e.next=5,(0,l.U2)("".concat(u.Q2,"/projects/").concat(n,"/upgrade/eligibility"),{signal:t});case 5:if(!(s=e.sent).error){e.next=8;break}throw s.error;case 8:return e.abrupt("return",s);case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}var g=function(e){var r=e.projectRef,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=t.enabled,i=(0,s.Z)(t,p);return(0,c.a)(d.U.upgradeEligibility(r),function(e){return function(e,r){return h.apply(this,arguments)}({projectRef:r},e.signal)},function(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?f(Object(t),!0).forEach(function(r){(0,n.Z)(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):f(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})}return e}({enabled:(void 0===o||o)&&void 0!==r},i))}}}]);